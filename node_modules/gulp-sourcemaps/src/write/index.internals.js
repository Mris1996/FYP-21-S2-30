'use strict';

module.exports = function(destPath, options) {

  var utils = require('../utils'),
    unixStylePath = utils.unixStylePath,
    PLUGIN_NAME = utils.PLUGIN_NAME,
    fs = require('graceful-fs'),
    path = require('path'),
    stripBom = require('strip-bom'),
    makeDebug = require('debug-fabulous')();

  var rootDebug = makeDebug(PLUGIN_NAME + ':write:internals');
  rootDebug(utils.logCb("options"));
  rootDebug(utils.logCb(options));

  function setSourceRoot(file) {
    var debug = makeDebug(PLUGIN_NAME + ':write:internals:setSourceRoot');

    var sourceMap = file.sourceMap;
    if (typeof options.sourceRoot === 'function') {
      debug(utils.logCb('is function'));
      sourceMap.sourceRoot = options.sourceRoot(file);
    } else {
      debug(utils.logCb('from options'));
      sourceMap.sourceRoot = options.sourceRoot;
    }
    if (sourceMap.sourceRoot === null) {
      debug(utils.logCb('undefined'));
      sourceMap.sourceRoot = undefined;
    }
  }

  function mapSources(file) {
    